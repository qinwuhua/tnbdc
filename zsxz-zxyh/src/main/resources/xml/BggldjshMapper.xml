<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.zxyh.mapper.BggldjshMapper">
    <resultMap type="com.hdsx.zxyh.entity.Bggldjsh" id="djsh">
        <result column="djbh" property="djbh"/>
        <result column="gcmc" property="gcmc"/>
        <result column="sqrq" property="sqrq"/>
        <result column="htmc" property="htmc"/>
        <result column="cbdw" property="cbdw"/>
        <result column="gldw" property="gldw"/>
        <result column="sjsm" property="sjsm"/>
        <result column="bzdw" property="bzdw"/>
        <result column="bzdwbh" property="bzdwbh"/>
        <result column="bzrq" property="bzrq"/>
        <result column="spzt" property="spzt"/>
        <result column="htbh" property="htbh"/>

        <collection property="mx" ofType="com.hdsx.zxyh.entity.Bggldjshmx" column="djshmx">
            <result column="mxdjbh" property="mxdjbh"/>
            <result column="zmh" property="zmh"/>
            <result column="zmmc" property="zmmc"/>
            <result column="dw" property="dw"/>
            <result column="htdj" property="htdj"/>
            <result column="cbrsddj" property="cbrsddj"/>
            <result column="jlsddj" property="jlsddj"/>
            <result column="qdjg" property="qdjg"/>
            <result column="zmid" property="zmid"/>
            <result column="mxhtbh" property="mxhtbh"/>

        </collection>

    </resultMap>

    <resultMap type="com.hdsx.zxyh.entity.Bggldjsh" id="djsh2">
        <result column="djbh" property="djbh"/>
        <result column="gcmc" property="gcmc"/>
        <result column="sqrq" property="sqrq"/>
        <result column="htmc" property="htmc"/>
        <result column="cbdw" property="cbdw"/>
        <result column="gldw" property="gldw"/>
        <result column="sjsm" property="sjsm"/>
        <result column="bzdw" property="bzdw"/>
        <result column="bzdwbh" property="bzdwbh"/>
        <result column="bzrq" property="bzrq"/>
        <result column="spzt" property="spzt"/>
        <result column="htbh" property="htbh"/>

        <collection property="mx" ofType="com.hdsx.zxyh.entity.Bggldjshmx" select="getDjshMX" column="djbh">

        </collection>

    </resultMap>

    <select id="getDjshMX" parameterType="string" resultType="com.hdsx.zxyh.entity.Bggldjshmx">
        select * from zxyh_djshbmx where mxdjbh=#{value}
    </select>

    <select id="getHtDjshInfoByBm" parameterType="hashmap" resultMap="djsh">
        select gj.HTGJXX_cgxmmc gcmc,ht.HTXX_HTMC htmc,ht.htxx_htbh htbh,xm.yhhtxx_cbdw cbdw,xm.yhhtxx_gldw gldw,
        zm.zmht_zmh zmh,zm.zmht_zmmc zmmc,zm.zmht_jldw dw,zm.zmht_dj htdj,zm.zmht_id zmid,zm.zmht_htbh mxhtbh
        from djsj_htxx ht left join djsj_htxx_htgjxx gj on ht.htxx_htbh=gj.HTGJXX_htbh left join djsj_htxx_yhxmxx xm on ht.htxx_htbh=xm.yhhtxx_htbh
        left join zm_ht zm on ht.htxx_htbh=zm.zmht_htbh
        where 1=1
        <if test="htbh != null and htbh != ''">
            and ht.htxx_htbh=#{htbh}
        </if>
        order by htbh,zmh
    </select>

    <insert id="addDjshMxForGcys" parameterType="com.hdsx.zxyh.entity.Bggldjsh">
        begin
        <foreach collection="mx" item="item" index="index" separator=";">
            insert into zxyh_djshbmx(mxdjbh,zmh, zmmc, dw, htdj, cbrsddj, jlsddj, qdjg, zmid, mxhtbh)  values
            (trim(#{djbh}),trim(#{item.zmh}),trim(#{item.zmmc}),trim(#{item.dw}),trim(#{item.htdj}),trim(#{item.cbrsddj,jdbcType=VARCHAR}),trim(#{item.jlsddj,jdbcType=VARCHAR}),trim(#{item.qdjg,jdbcType=VARCHAR}),trim(#{item.zmid}),trim(#{item.mxhtbh}))
        </foreach>
        ;end;
    </insert>

    <insert id="addDjshForGcys" parameterType="com.hdsx.zxyh.entity.Bggldjsh">
        insert into zxyh_djshb
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="htbh != null" >htbh,</if>
            <if test="djbh != null" >djbh,</if>
            <if test="gcmc != null" >gcmc,</if>
            <if test="sqrq != null" >sqrq,</if>
            <if test="htmc != null" >htmc,</if>
            <if test="cbdw != null" >cbdw,</if>
            <if test="gldw != null" >gldw,</if>
            <if test="sjsm != null" >sjsm,</if>
            <if test="bzdw != null" >bzdw,</if>
            <if test="bzdwbh != null" >bzdwbh,</if>
            <if test="bzrq != null" >bzrq,</if>

        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="htbh != null" >#{htbh},</if>
            <if test="djbh != null" >#{djbh},</if>
            <if test="gcmc != null" >#{gcmc},</if>
            <if test="sqrq != null" >#{sqrq},</if>
            <if test="htmc != null" >#{htmc},</if>
            <if test="cbdw != null" >#{cbdw},</if>
            <if test="gldw != null" >#{gldw},</if>
            <if test="sjsm != null" >#{sjsm},</if>
            <if test="bzdw != null" >#{bzdw},</if>
            <if test="bzdwbh != null" >#{bzdwbh},</if>
            <if test="bzrq != null" >#{bzrq},</if>

        </trim>
    </insert>

    <delete id="delDjshMxByDjbh" parameterType="string">
        delete from zxyh_djshbmx where mxdjbh=#{value}
    </delete>

    <update id="editDjshForGcys" parameterType="com.hdsx.zxyh.entity.Bggldjsh" >
        update zxyh_djshb
        <set>
            <if test="htbh != null" >htbh=#{htbh},</if>
            <if test="djbh != null" >djbh=#{djbh},</if>
            <if test="gcmc != null" >gcmc=#{gcmc},</if>
            <if test="sqrq != null" >sqrq=#{sqrq},</if>
            <if test="htmc != null" >htmc=#{htmc},</if>
            <if test="cbdw != null" >cbdw=#{cbdw},</if>
            <if test="gldw != null" >gldw=#{gldw},</if>
            <if test="sjsm != null" >sjsm=#{sjsm},</if>
            <if test="bzdw != null" >bzdw=#{bzdw},</if>
            <if test="bzdwbh != null" >bzdwbh=#{bzdwbh},</if>
            <if test="bzrq != null" >bzrq=#{bzrq},</if>
        </set>
        where 1=1 and djbh=#{djbh}
    </update>

    <delete id="delDjshMxForGcys" parameterType="java.util.List" >
        delete from zxyh_djshbmx
        where mxdjbh in
        <foreach collection="list" item="id"  open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    <delete id="delDjshForGcys" parameterType="java.util.List" >
        delete from zxyh_djshb
        where djbh in
        <foreach collection="list" item="id"  open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>



    <select id="getDjshList" parameterType="hashmap" resultMap="djsh2">

        select zb.*
        from
        zxyh_djshb zb
        where 1=1
        <if test="dwbh != null and dwbh != ''">
            and zb.bzdwbh like '%'||#{dwbh}||'%'
        </if>
        <if test="htbh != null and htbh != ''">
            and zb.htbh=#{htbh}
        </if>
        <if test="ksrq != null and ksrq != ''">
            and to_date(sqrq,'yyyy-mm-dd')>=to_date(#{ksrq},'yyyy-mm-dd')
        </if>
        <if test="jsrq != null and jsrq != ''">
            and to_date(sqrq,'yyyy-mm-dd')&lt;=to_date(#{jsrq},'yyyy-mm-dd')
        </if>
    </select>

    <select id="getDjshInfoByDjbh" parameterType="hashmap" resultMap="djsh">

        select zb.*,fb.*
        from
        zxyh_djshb zb left join zxyh_djshbmx fb on zb.djbh=fb.mxdjbh
        where 1=1 and zb.djbh=#{djbh}

    </select>
    <update id="spDjshForGcys" parameterType="hashmap">
        update zxyh_djshb set SPZT=#{spzt}
        where djbh in
        <foreach collection="djbhs" item="id"  open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>


    <select id="getHtInfoByZmh" parameterType="hashmap" resultMap="djsh">

        select gj.HTGJXX_cgxmmc gcmc,ht.HTXX_HTMC htmc,ht.htxx_htbh htbh,xm.yhhtxx_cbdw cbdw,xm.yhhtxx_gldw gldw,
        zm.zmht_zmh zmh,zm.zmht_zmmc zmmc,zm.zmht_jldw dw,zm.zmht_dj htdj,zm.zmht_id zmid,zm.zmht_htbh mxhtbh
        from djsj_htxx ht left join djsj_htxx_htgjxx gj on ht.htxx_htbh=gj.HTGJXX_htbh left join djsj_htxx_yhxmxx xm on ht.htxx_htbh=xm.yhhtxx_htbh
        left join zm_ht zm on ht.htxx_htbh=zm.zmht_htbh
        where 1=1 and zm.zmht_zmh=#{zmh}

        order by htbh,zmh

    </select>


</mapper>